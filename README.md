# Full-Stack приложение для управления пользователями

## Описание проекта

Этот проект представляет собой полноценное Full-Stack приложение, включающее в себя RESTful API для управления пользователями и современный фронтенд, разработанный на React. Бэкенд предоставляет функционал для регистрации, аутентификации, управления профилями и блокировки пользователей. Фронтенд обеспечивает удобный пользовательский интерфейс для взаимодействия с API.

## Основные возможности:

-   **Регистрация и аутентификация:** Пользователи могут регистрироваться и входить в систему, получая Access и Refresh токены.
-   **Управление токенами:** Поддержка обновления Access токенов с помощью Refresh токенов и выхода из системы.
-   **Авторизация по ролям:** Разграничение доступа к ресурсам на основе ролей пользователей (USER, ADMIN).
-   **Управление пользователями:** Администраторы могут просматривать и блокировать пользователей.
-   **Валидация данных:** Строгая валидация входных данных для всех эндпоинтов.
-   **Обработка ошибок:** Централизованная система обработки ошибок с понятными HTTP-статусами.

## Технологический стек

Проект разработан с использованием следующих ключевых технологий и библиотек:

-   **Node.js:** Среда выполнения JavaScript.
-   **TypeScript:** Строго типизированный язык программирования, компилируемый в JavaScript, для повышения надежности и удобства разработки.
-   **Express.js:** Быстрый, несложный и минималистичный веб-фреймворк для Node.js, используемый для построения API.
-   **PostgreSQL:** Мощная, открытая объектно-реляционная система управления базами данных, работающая в Docker-контейнере.
-   **Prisma ORM:** Современный ORM (Object-Relational Mapper) для Node.js и TypeScript, упрощающий взаимодействие с базой данных.
-   **JWT (JSON Web Tokens):** Стандарт для создания токенов доступа, используемый для аутентификации (Access и Refresh токены).
-   **bcrypt:** Библиотека для безопасного хэширования паролей.
-   **Jest:** Фреймворк для тестирования JavaScript-кода, используемый для юнит-тестов.
-   **express-validator:** Набор middleware для валидации входных данных в Express.js.
-   **cors:** Middleware для Express.js, позволяющий настроить Cross-Origin Resource Sharing.
-   **helmet:** Набор middleware для Express.js, повышающий безопасность HTTP-заголовков.
-   **dotenv:** Библиотека для загрузки переменных окружения из файла `.env`.
-   **cookie-parser:** Middleware для парсинга HTTP-куки.
-   **express-async-errors:** Упрощает обработку асинхронных ошибок в Express.js, устраняя необходимость в `try-catch` блоках в каждом асинхронном контроллере.
-   **React:** Библиотека для создания пользовательских интерфейсов.
-   **React Router:** Для маршрутизации на стороне клиента.

## Установка и запуск проекта (Пошаговая инструкция)

Для успешной установки и запуска проекта следуйте этим инструкциям. Предполагается, что у вас установлены `Node.js` (рекомендуется LTS версия), `npm` (или `yarn`) и `Docker`.

### 1. Клонирование репозитория

Откройте терминал или командную строку и выполните команду:

```bash
git clone https://github.com/Sskutushev/Test-effective-mobile_2.0.0.git
cd Test-effective-mobile_2.0
```

### 2. Установка зависимостей

Перейдите в корневую директорию проекта и установите все необходимые пакеты:

```bash
npm install
# или
yarn install
```

### 3. Запуск базы данных PostgreSQL с помощью Docker Compose

Проект использует PostgreSQL, запущенный в Docker-контейнере. Убедитесь, что Docker запущен на вашей машине.

```bash
docker-compose up -d
```

Эта команда запустит контейнер PostgreSQL на порту `5432`. База данных будет доступна по адресу `localhost:5432` с именем пользователя `user`, паролем `password` и именем БД `effective_mobile_db`.

### 4. Настройка переменных окружения

Создайте файл `.env` в корневой директории проекта. Скопируйте в него содержимое из `.env.example` (если он есть, или создайте вручную) и заполните его:

```env
PORT=5000
DATABASE_URL="postgresql://user:password@localhost:5432/effective_mobile_db?schema=public"
JWT_ACCESS_SECRET=your_very_secret_access_key_here # Обязательно замените на длинную случайную строку!
JWT_REFRESH_SECRET=your_very_secret_refresh_key_here # Обязательно замените на длинную случайную строку!
CLIENT_URL=http://localhost:3000 # URL вашего фронтенд приложения, если есть. Для разработки можно оставить так.
```

*   **Важно:** Замените `your_very_secret_access_key_here` и `your_very_secret_refresh_key_here` на уникальные, длинные и случайные строки. Это критически важно для безопасности вашего приложения.

### 5. Генерация Prisma Client и применение миграций

После настройки базы данных и переменных окружения необходимо сгенерировать Prisma Client и применить миграции, чтобы создать таблицы в базе данных.

```bash
npx prisma generate
npx prisma migrate dev --name init
```

*   `npx prisma generate` создает клиент Prisma, который позволяет вашему приложению взаимодействовать с базой данных.
*   `npx prisma migrate dev --name init` создает и применяет миграцию, которая синхронизирует схему вашей базы данных с `prisma/schema.prisma`.

### 6. Запуск Seed-скрипта (добавление тестового администратора)

Проект включает seed-скрипт, который добавляет тестового пользователя с ролью администратора. Это удобно для начала работы и тестирования.

```bash
npx prisma db seed
```

*   **Данные тестового администратора:**
    *   Email: `admin@example.com`
    *   Password: `admin123`

### 7. Запуск проекта

Теперь вы можете запустить сервер в режиме разработки:

```bash
npm run dev
```

Сервер будет доступен по адресу `http://localhost:5000` (или на порту, указанном в вашей переменной `PORT` в `.env`).

### 8. Установка и запуск фронтенда

1.  **Перейдите в папку фронтенда:**
    ```bash
    cd frontend
    ```

2.  **Установите зависимости:**
    ```bash
    npm install
    ```

3.  **Запустите сервер для разработки:**
    ```bash
    npm start
    ```
    Фронтенд будет доступен по адресу `http://localhost:3000`.

## Эндпоинты API

Все эндпоинты возвращают JSON-ответы. Для аутентифицированных запросов необходимо передавать `Access Token` в заголовке `Authorization: Bearer <accessToken>`.

### Аутентификация

-   **`POST /api/auth/register`** - Регистрация нового пользователя
    -   **Описание:** Создает нового пользователя в системе.
    -   **Request Body:**
        ```json
        {
          "fullName": "Иван Иванов",
          "birthDate": "1990-01-01",
          "email": "ivan@example.com",
          "password": "password123"
        }
        ```
    -   **Response (Success 200):**
        ```json
        {
          "message": "Регистрация успешна",
          "user": {
            "id": 1,
            "fullName": "Иван Иванов",
            "email": "ivan@example.com",
            "role": "USER",
            "status": "ACTIVE"
          },
          "accessToken": "eyJ..."
        }
        ```

-   **`POST /api/auth/login`** - Авторизация пользователя
    -   **Описание:** Аутентифицирует пользователя и выдает Access и Refresh токены.
    -   **Request Body:**
        ```json
        {
          "email": "ivan@example.com",
          "password": "password123"
        }
        ```
    -   **Response (Success 200):**
        ```json
        {
          "accessToken": "eyJ...",
          "refreshToken": "eyJ...",
          "user": {
            "id": 1,
            "fullName": "Иван Иванов",
            "email": "ivan@example.com",
            "role": "USER"
          }
        }
        ```

-   **`POST /api/auth/refresh`** - Обновление Access Token
    -   **Описание:** Использует Refresh Token (передается в HTTP-only cookie) для получения нового Access Token.
    -   **Request (с `refreshToken` в cookies):**
        ```bash
        curl -X POST http://localhost:5000/api/auth/refresh \
          --cookie "refreshToken=<ВАШ_REFRESH_TOKEN_ИЗ_КУКИ>"
        ```
    -   **Response (Success 200):**
        ```json
        {
          "accessToken": "eyJ..."
        }
        ```

-   **`POST /api/auth/logout`** - Выход пользователя
    -   **Описание:** Завершает сессию пользователя, удаляя Refresh Token из базы данных и очищая соответствующую cookie.
    -   **Request (с `refreshToken` в cookies):**
        ```bash
        curl -X POST http://localhost:5000/api/auth/logout \
          --cookie "refreshToken=<ВАШ_REFRESH_TOKEN_ИЗ_КУКИ>"
        ```
    -   **Response (Success 200):**
        ```json
        {
          "message": "Выход выполнен успешно"
        }
        ```

### Управление пользователями

-   **`GET /api/users/:id`** - Получение пользователя по ID
    -   **Описание:** Возвращает информацию о пользователе по его уникальному ID.
    -   **Headers:** `Authorization: Bearer <accessToken>`
    -   **Response (Success 200):**
        ```json
        {
          "id": 1,
          "fullName": "Иван Иванов",
          "birthDate": "1990-01-01T00:00:00.000Z",
          "email": "ivan@example.com",
          "role": "USER",
          "status": "ACTIVE",
          "createdAt": "2023-01-01T10:00:00.000Z"
        }
        ```

-   **`GET /api/users`** - Получение списка всех пользователей
    -   **Описание:** Возвращает массив всех зарегистрированных пользователей. Доступно только для администраторов.
    -   **Headers:** `Authorization: Bearer <accessToken>`
    -   **Response (Success 200):** Массив объектов пользователей (без полей `password` и `refreshToken`).

-   **`PATCH /api/users/:id/block`** - Блокировка пользователя
    -   **Описание:** Изменяет статус пользователя на `BLOCKED`. Доступно только для администраторов. Администратор не может заблокировать сам себя или единственного активного администратора.
    -   **Headers:** `Authorization: Bearer <accessToken>`
    -   **Response (Success 200):**
        ```json
        {
          "message": "Пользователь успешно заблокирован",
          "user": {
            "id": 2,
            "status": "BLOCKED"
          }
        }
        ```

## Тестирование

Проект включает набор юнит-тестов, написанных с использованием Jest, для проверки основной бизнес-логики и утилит.

Для запуска тестов выполните команду:

```bash
npm test
```

Все тесты должны пройти успешно, подтверждая корректность работы ключевых компонентов.

## Скрипты `package.json`

В файле `package.json` определены следующие полезные скрипты:

-   `npm run dev`: Запускает сервер в режиме разработки с `ts-node-dev`, который автоматически перезагружает сервер при изменениях в коде.
-   `npm run build`: Компилирует TypeScript-код в JavaScript, создавая готовую к деплою директорию `dist`.
-   `npm run start`: Запускает скомпилированное JavaScript-приложение из директории `dist`.
-   `npm test`: Запускает все юнит-тесты с помощью Jest.
-   `npm run prisma:migrate`: Применяет миграции Prisma к базе данных.
-   `npm run prisma:generate`: Генерирует Prisma Client на основе `prisma/schema.prisma`.
-   `npm run prisma:seed`: Запускает seed-скрипт для заполнения базы данных начальными данными (например, тестовым администратором).

## Конфигурация Jest

Файл `jest.config.js` настроен для работы с TypeScript через `ts-jest` и включает маппинг модулей для корректной обработки `@prisma/client` в тестовой среде.

## Структура проекта

```
. (корень проекта)
├── frontend/              # Исходный код фронтенд-приложения на React
│   ├── public/              # Статические файлы и index.html
│   └── src/                 # Исходный код React-компонентов, страниц и стилей
├── src/                   # Исходный код бэкенд-приложения
│   ├── controllers/         # Обработчики HTTP-запросов (authController, userController)
│   ├── services/            # Бизнес-логика приложения (authService, userService)
│   ├── middlewares/         # Промежуточное ПО (authMiddleware, roleMiddleware, validationMiddleware, errorMiddleware)
│   ├── routes/              # Определение маршрутов API (authRoutes, userRoutes)
│   ├── utils/               # Вспомогательные утилиты (passwordUtils, jwtUtils, prismaClient)
│   ├── types/               # Определение пользовательских типов (express.d.ts)
│   ├── config/              # Конфигурация приложения (env.ts)
│   └── server.ts            # Точка входа в приложение, настройка Express
├── prisma/
│   ├── migrations/          # Автоматически генерируемые миграции базы данных
│   ├── seed.ts              # Скрипт для заполнения базы данных начальными данными
│   └── schema.prisma        # Определение схемы базы данных для Prisma ORM
├── tests/
│   └── unit/                # Юнит-тесты для сервисов и утилит
│       └── __mocks__/
│           └── @prisma/client.ts # Мок для @prisma/client для изоляции тестов
├── .env.example             # Пример файла с переменными окружения
├── .gitignore               # Файл для игнорирования Git-ом
├── package.json             # Описание проекта и зависимости
├── tsconfig.json            # Конфигурация TypeScript для проекта
├── tsconfig.jest.json       # Конфигурация TypeScript специально для Jest
├── jest.config.js           # Конфигурация Jest
└── README.md                # Документация проекта
```

## Устранение неполадок

Если вы столкнулись с проблемами при запуске или тестировании, попробуйте следующие шаги:

1.  **Проверьте Docker:** Убедитесь, что контейнер PostgreSQL запущен (`docker-compose ps`). Если нет, запустите его (`docker-compose up -d`).
2.  **Перегенерируйте Prisma Client:** Иногда проблемы с типами могут быть решены повторной генерацией клиента: `npx prisma generate`.
3.  **Очистите кэш Jest:** Если тесты ведут себя странно, попробуйте очистить кэш Jest: `npm test -- --clearCache`.
4.  **Проверьте `.env`:** Убедитесь, что все переменные окружения в файле `.env` настроены правильно, особенно `DATABASE_URL` и секретные ключи JWT.

## Развертывание (Deployment)

Этот репозиторий настроен для автоматической сборки и развертывания фронтенд-части на GitHub Pages. Любые изменения, отправленные в ветку `master`, запустят новый процесс развертывания.

Рабочее приложение доступно по адресу: [https://sskutushev.github.io/Test-effective-mobile_2.0.0/](https://sskutushev.github.io/Test-effective-mobile_2.0.0/)
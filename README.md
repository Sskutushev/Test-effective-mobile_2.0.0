# Full-Stack приложение для управления пользователями с Telegram Mini App

## Описание проекта

Этот проект представляет собой полноценное Full-Stack приложение, включающее в себя RESTful API для управления пользователями, современный фронтенд, разработанный на React, и интеграцию с Telegram-ботом, который запускает веб-приложение (Telegram Mini App). Бэкенд предоставляет функционал для регистрации, аутентификации, управления профилями и блокировки пользователей. Фронтенд обеспечивает удобный пользовательский интерфейс для взаимодействия с API. Telegram-бот служит точкой входа для пользователей в Mini App.

## Основные возможности:

-   **Регистрация и аутентификация:** Пользователи могут регистрироваться и входить в систему, получая Access и Refresh токены.
-   **Управление токенами:** Поддержка обновления Access токенов с помощью Refresh токенов и выхода из системы.
-   **Авторизация по ролям:** Разграничение доступа к ресурсам на основе ролей пользователей (USER, ADMIN).
-   **Управление пользователями:** Администраторы могут просматривать и блокировать пользователей.
-   **Валидация данных:** Строгая валидация входных данных для всех эндпоинтов.
-   **Обработка ошибок:** Централизованная система обработки ошибок с понятными HTTP-статусами.
-   **Интеграция с Telegram-ботом:** Запуск веб-приложения (Telegram Mini App) через бота.

## Технологический стек

Проект разработан с использованием следующих ключевых технологий и библиотек:

-   **Node.js:** Среда выполнения JavaScript.
-   **TypeScript:** Строго типизированный язык программирования, компилируемый в JavaScript, для повышения надежности и удобства разработки.
-   **Express.js:** Быстрый, несложный и минималистичный веб-фреймворк для Node.js, используемый для построения API.
-   **Telegraf.js:** Современная и гибкая библиотека для создания Telegram-ботов на Node.js.
-   **PostgreSQL:** Мощная, открытая объектно-реляционная система управления базами данных, работающая в Docker-контейнере.
-   **Prisma ORM:** Современный ORM (Object-Relational Mapper) для Node.js и TypeScript, упрощающий взаимодействие с базой данных.
-   **JWT (JSON Web Tokens):** Стандарт для создания токенов доступа, используемый для аутентификации (Access и Refresh токены).
-   **bcrypt:** Библиотека для безопасного хэширования паролей.
-   **Jest:** Фреймворк для тестирования JavaScript-кода, используемый для юнит-тестов.
-   **express-validator:** Набор middleware для валидации входных данных в Express.js.
-   **cors:** Middleware для Express.js, позволяющий настроить Cross-Origin Resource Sharing.
-   **helmet:** Набор middleware для Express.js, повышающий безопасность HTTP-заголовков.
-   **dotenv:** Библиотека для загрузки переменных окружения из файла `.env`.
-   **cookie-parser:** Middleware для парсинга HTTP-куки.
-   **express-async-errors:** Упрощает обработку асинхронных ошибок в Express.js, устраняя необходимость в `try-catch` блоках в каждом асинхронном контроллере.
-   **React:** Библиотека для создания пользовательских интерфейсов.
-   **React Router:** Для маршрутизации на стороне клиента.
-   **gh-pages:** Библиотека для удобного развертывания фронтенда на GitHub Pages.

## Установка и запуск проекта (Пошаговая инструкция)

Для успешной установки и запуска проекта следуйте этим инструкциям. Предполагается, что у вас установлены `Node.js` (рекомендуется LTS версия), `npm` (или `yarn`) и `Docker`.

### 1. Клонирование репозитория

Откройте терминал или командную строку и выполните команду:

```bash
git clone https://github.com/Sskutushev/Test-effective-mobile_2.0.0.git
cd Test-effective-mobile_2.0.0
```

### 2. Установка зависимостей

Перейдите в корневую директорию проекта и установите все необходимые пакеты для бэкенда:

```bash
npm install
# или
yarn install
```

Затем перейдите в директорию `frontend` и установите зависимости для фронтенда:

```bash
cd frontend
npm install
# или
yarn install
cd ..
```

### 3. Запуск базы данных PostgreSQL с помощью Docker Compose

Проект использует PostgreSQL, запущенный в Docker-контейнере. Убедитесь, что Docker запущен на вашей машине.

```bash
docker-compose up -d
```

Эта команда запустит контейнер PostgreSQL на порту `5432`. База данных будет доступна по адресу `localhost:5432` с именем пользователя `user`, паролем `password` и именем БД `effective_mobile_db`.

### 4. Настройка переменных окружения

Создайте файл `.env` в корневой директории проекта. Скопируйте в него содержимое из `.env.example` (если он есть, или создайте вручную) и заполните его. **Обязательно замените секретные ключи на длинные случайные строки и укажите ваш `BOT_TOKEN`**.

```env
PORT=5000
DATABASE_URL="postgresql://user:password@localhost:5432/effective_mobile_db?schema=public"
JWT_ACCESS_SECRET=your_very_secret_access_key_here # Обязательно замените на длинную случайную строку!
JWT_REFRESH_SECRET=your_very_secret_refresh_key_here # Обязательно замените на длинную случайную строку!
CLIENT_URL=http://localhost:3000 # URL вашего фронтенд приложения, если есть. Для разработки можно оставить так.
BOT_TOKEN=YOUR_TELEGRAM_BOT_TOKEN_HERE # Токен вашего Telegram-бота
```

*   **Важно:** Замените `your_very_secret_access_key_here`, `your_very_secret_refresh_key_here` и `YOUR_TELEGRAM_BOT_TOKEN_HERE` на актуальные значения.

### 5. Генерация Prisma Client и применение миграций

После настройки базы данных и переменных окружения необходимо сгенерировать Prisma Client и применить миграции, чтобы создать таблицы в базе данных.

```bash
npx prisma generate
npx prisma migrate dev --name init
```

*   `npx prisma generate` создает клиент Prisma, который позволяет вашему приложению взаимодействовать с базой данных.
*   `npx prisma migrate dev --name init` создает и применяет миграцию, которая синхронизирует схему вашей базы данных с `prisma/schema.prisma`.

### 6. Запуск Seed-скрипта (добавление тестового администратора)

Проект включает seed-скрипт, который добавляет тестового пользователя с ролью администратора. Это удобно для начала работы и тестирования.

```bash
npx prisma db seed
```

*   **Данные тестового администратора:**
    *   Email: `admin@example.com`
    *   Password: `admin123`

### 7. Запуск проекта

Теперь вы можете запустить бэкенд-сервер и Telegram-бота в режиме разработки:

```bash
npm run dev
```

Сервер будет доступен по адресу `http://localhost:5000` (или на порту, указанном в вашей переменной `PORT` в `.env`). Telegram-бот также будет запущен.

Затем запустите фронтенд-приложение:

```bash
cd frontend
npm start
```

Фронтенд будет доступен по адресу `http://localhost:3000`.

## Эндпоинты API

Все эндпоинты возвращают JSON-ответы. Для аутентифицированных запросов необходимо передавать `Access Token` в заголовке `Authorization: Bearer <accessToken>`.

### Аутентификация

-   **`POST /api/auth/register`** - Регистрация нового пользователя
    -   **Описание:** Создает нового пользователя в системе.
    -   **Request Body:**
        ```json
        {
          "fullName": "Иван Иванов",
          "birthDate": "1990-01-01",
          "email": "ivan@example.com",
          "password": "password123"
        }
        ```
    -   **Response (Success 200):**
        ```json
        {
          "message": "Регистрация успешна",
          "user": {
            "id": 1,
            "fullName": "Иван Иванов",
            "email": "ivan@example.com",
            "role": "USER",
            "status": "ACTIVE"
          },
          "accessToken": "eyJ..."
        }
        ```

-   **`POST /api/auth/login`** - Авторизация пользователя
    -   **Описание:** Аутентифицирует пользователя и выдает Access и Refresh токены.
    -   **Request Body:**
        ```json
        {
          "email": "ivan@example.com",
          "password": "password123"
        }
        ```
    -   **Response (Success 200):**
        ```json
        {
          "accessToken": "eyJ...",
          "refreshToken": "eyJ...",
          "user": {
            "id": 1,
            "fullName": "Иван Иванов",
            "email": "ivan@example.com",
            "role": "USER"
          }
        }
        ```

-   **`POST /api/auth/refresh`** - Обновление Access Token
    -   **Описание:** Использует Refresh Token (передается в HTTP-only cookie) для получения нового Access Token.
    -   **Request (с `refreshToken` в cookies):**
        ```bash
        curl -X POST http://localhost:5000/api/auth/refresh \
          --cookie "refreshToken=<ВАШ_REFRESH_TOKEN_ИЗ_КУКИ>"
        ```
    -   **Response (Success 200):**
        ```json
        {
          "accessToken": "eyJ..."
        }
        ```

-   **`POST /api/auth/logout`** - Выход пользователя
    -   **Описание:** Завершает сессию пользователя, удаляя Refresh Token из базы данных и очищая соответствующую cookie.
    -   **Request (с `refreshToken` в cookies):**
        ```bash
        curl -X POST http://localhost:5000/api/auth/logout \
          --cookie "refreshToken=<ВАШ_REFRESH_TOKEN_ИЗ_КУКИ>"
        ```
    -   **Response (Success 200):**
        ```json
        {
          "message": "Выход выполнен успешно"
        }
        ```

### Управление пользователями

-   **`GET /api/users/:id`** - Получение пользователя по ID
    -   **Описание:** Возвращает информацию о пользователе по его уникальному ID.
    -   **Headers:** `Authorization: Bearer <accessToken>`
    -   **Response (Success 200):**
        ```json
        {
          "id": 1,
          "fullName": "Иван Иванов",
          "birthDate": "1990-01-01T00:00:00.000Z",
          "email": "ivan@example.com",
          "role": "USER",
          "status": "ACTIVE",
          "createdAt": "2023-01-01T10:00:00.000Z"
        }
        ```

-   **`GET /api/users`** - Получение списка всех пользователей
    -   **Описание:** Возвращает массив всех зарегистрированных пользователей. Доступно только для администраторов.
    -   **Headers:** `Authorization: Bearer <accessToken>`
    -   **Response (Success 200):** Массив объектов пользователей (без полей `password` и `refreshToken`).

-   **`PATCH /api/users/:id/block`** - Блокировка пользователя
    -   **Описание:** Изменяет статус пользователя на `BLOCKED`. Доступно только для администраторов. Администратор не может заблокировать сам себя или единственного активного администратора.
    -   **Headers:** `Authorization: Bearer <accessToken>`
    -   **Response (Success 200):**
        ```json
        {
          "message": "Пользователь успешно заблокирован",
          "user": {
            "id": 2,
            "status": "BLOCKED"
          }
        }
        ```

## Тестирование

Проект включает набор юнит-тестов, написанных с использованием Jest, для проверки основной бизнес-логики и утилит.

### 1. Юнит-тесты бэкенда

Для запуска юнит-тестов выполните команду в корневой директории проекта:

```bash
npm test
```

Все тесты должны пройти успешно, подтверждая корректность работы ключевых компонентов.

### 2. Тестирование API бэкенда (вручную)

Вы можете вручную проверить работу API-эндпоинтов, используя такие инструменты, как `curl` (примеры запросов приведены выше в разделе "Эндпоинты API") или Postman/Insomnia.

### 3. Тестирование фронтенда (визуально)

После запуска фронтенда (`npm start` в директории `frontend`) откройте `http://localhost:3000` в браузере и проверьте:
*   Отображение заголовка на лендинге.
*   Корректность работы страницы авторизации/регистрации, включая адаптивность на мобильных устройствах.
*   Навигацию по страницам.
*   Взаимодействие с формами и другими элементами UI.

### 4. Тестирование Telegram-бота

1.  Убедитесь, что бэкенд-сервер запущен (`npm run dev` в корне проекта).
2.  Откройте Telegram и найдите вашего бота (имя пользователя бота).
3.  Начните диалог с ботом (`/start`).
4.  Нажмите на кнопку "Open App" (или аналогичную), чтобы запустить Telegram Mini App.
5.  Убедитесь, что Mini App корректно загружает фронтенд-приложение.

## Развертывание (Deployment)

Фронтенд-часть проекта настроена для развертывания на GitHub Pages.

1.  **Сборка проекта:** Убедитесь, что вы находитесь в директории `frontend` и выполните команду для сборки проекта:
    ```bash
npm run build
```
    Эта команда создаст оптимизированную сборку в папке `build`.

2.  **Развертывание на GitHub Pages:** После успешной сборки выполните команду для развертывания:
    ```bash
npm run deploy
```
    Эта команда использует библиотеку `gh-pages` для публикации содержимого папки `build` в ветку `gh-pages` вашего репозитория. GitHub Pages автоматически развернет это содержимое.

Рабочее приложение будет доступно по адресу, указанному в поле `homepage` вашего `frontend/package.json` (например, `https://sskutushev.github.io/Test-effective-mobile_2.0.0/`). Учтите, что развертывание может занять несколько минут.

## Скрипты `package.json`

В файле `package.json` (корневой директории) определены следующие полезные скрипты:

-   `npm run dev`: Запускает бэкенд-сервер и Telegram-бота в режиме разработки с `ts-node-dev`, который автоматически перезагружает сервер при изменениях в коде.
-   `npm run build`: Компилирует TypeScript-код бэкенда в JavaScript, создавая готовую к деплою директорию `dist`.
-   `npm run start`: Запускает скомпилированное JavaScript-приложение бэкенда из директории `dist`.
-   `npm test`: Запускает все юнит-тесты бэкенда с помощью Jest.
-   `npm run prisma:migrate`: Применяет миграции Prisma к базе данных.
-   `npm run prisma:generate`: Генерирует Prisma Client на основе `prisma/schema.prisma`.
-   `npm run prisma:seed`: Запускает seed-скрипт для заполнения базы данных начальными данными (например, тестовым администратором).

В файле `frontend/package.json` определены скрипты для фронтенда:

-   `npm start`: Запускает фронтенд-приложение в режиме разработки.
-   `npm run build`: Создает оптимизированную сборку фронтенда для продакшена.
-   `npm test`: Запускает юнит-тесты фронтенда.
-   `npm run deploy`: Развертывает фронтенд на GitHub Pages.

## Конфигурация Jest

Файл `jest.config.js` настроен для работы с TypeScript через `ts-jest` и включает маппинг модулей для корректной обработки `@prisma/client` в тестовой среде.

## Структура проекта

```
. (корень проекта)
├── frontend/              # Исходный код фронтенд-приложения на React
│   ├── public/              # Статические файлы и index.html
│   └── src/                 # Исходный код React-компонентов, страниц и стилей
│       ├── pages/             # Страницы приложения (LandingPage, AuthPage и т.д.)
│       ├── components/        # Переиспользуемые компоненты (Header, Footer и т.д.)
│       └── logo.png           # Логотип проекта
├── src/                   # Исходный код бэкенд-приложения
│   ├── bot.ts               # Логика Telegram-бота
│   ├── controllers/         # Обработчики HTTP-запросов (authController, userController)
│   ├── services/            # Бизнес-логика приложения (authService, userService)
│   ├── middlewares/         # Промежуточное ПО (authMiddleware, roleMiddleware, validationMiddleware, errorMiddleware)
│   ├── routes/              # Определение маршрутов API (authRoutes, userRoutes)
│   ├── utils/               # Вспомогательные утилиты (passwordUtils, jwtUtils, prismaClient)
│   ├── types/               # Определение пользовательских типов (express.d.ts)
│   ├── config/              # Конфигурация приложения (env.ts)
│   └── server.ts            # Точка входа в приложение, настройка Express
├── prisma/
│   ├── migrations/          # Автоматически генерируемые миграции базы данных
│   ├── seed.ts              # Скрипт для заполнения базы данных начальными данными
│   └── schema.prisma        # Определение схемы базы данных для Prisma ORM
├── tests/
│   └── unit/                # Юнит-тесты для сервисов и утилит
│       └── __mocks__/
│           └── @prisma/client.ts # Мок для @prisma/client для изоляции тестов
├── .env.example             # Пример файла с переменными окружения
├── .gitignore               # Файл для игнорирования Git-ом
├── package.json             # Описание проекта и зависимости
├── tsconfig.json            # Конфигурация TypeScript для проекта
├── tsconfig.jest.json       # Конфигурация TypeScript специально для Jest
├── jest.config.js           # Конфигурация Jest
└── README.md                # Документация проекта

## Устранение неполадок

Если вы столкнулись с проблемами при запуске или тестировании, попробуйте следующие шаги:

1.  **Проверьте Docker:** Убедитесь, что контейнер PostgreSQL запущен (`docker-compose ps`). Если нет, запустите его (`docker-compose up -d`).
2.  **Перегенерируйте Prisma Client:** Иногда проблемы с типами могут быть решены повторной генерацией клиента: `npx prisma generate`.
3.  **Очистите кэш Jest:** Если тесты ведут себя странно, попробуйте очистить кэш Jest: `npm test -- --clearCache`.
4.  **Проверьте `.env`:** Убедитесь, что все переменные окружения в файле `.env` настроены правильно, особенно `DATABASE_URL`, `JWT_ACCESS_SECRET`, `JWT_REFRESH_SECRET` и `BOT_TOKEN`.

## Развертывание на GitHub Pages

Рабочее приложение доступно по адресу: [https://sskutushev.github.io/Test-effective-mobile_2.0.0/](https://sskutushev.github.io/Test-effective-mobile_2.0.0/) а также в телеграмм-боте с мини апп:@Testapptask_bot 
